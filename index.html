<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bot IA OTC (OpenAI)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-4">
  <div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold text-blue-400 mb-4 text-center">ðŸ¤– Bot Trading IA + OpenAI</h1>

    <div class="mb-4">
      <label for="pair">Paire OTC</label>
      <select id="pair" class="w-full p-2 bg-gray-800 rounded">
        <option value="EURUSD">EUR/USD</option>
        <option value="GBPUSD">GBP/USD</option>
        <option value="USDJPY">USD/JPY</option>
      </select>
    </div>

    <canvas id="chart" height="180" class="mb-4"></canvas>

    <div class="bg-gray-800 p-4 rounded mb-4">
      <h2 class="text-lg font-semibold text-blue-300">Signal IA</h2>
      <div id="signalBox" class="text-xl mt-2"></div>
    </div>

    <div class="bg-gray-800 p-4 rounded">
      <h2 class="text-lg font-semibold text-blue-300 mb-2">Historique</h2>
      <ul id="logBox" class="text-sm space-y-1 max-h-40 overflow-auto"></ul>
    </div>
  </div>

  <script>
    const API_KEY = '6XLTMJEEILYL1VE3'; // Alpha Vantage
    const signalBox = document.getElementById('signalBox');
    const logBox = document.getElementById('logBox');
    const pairSelect = document.getElementById('pair');
    const chartCtx = document.getElementById('chart').getContext('2d');
    let chart;

    async function fetchCandles(symbol) {
      const from = symbol.slice(0,3);
      const to = symbol.slice(3);
      const url = `https://www.alphavantage.co/query?function=FX_INTRADAY&from_symbol=${from}&to_symbol=${to}&interval=1min&apikey=${API_KEY}&outputsize=compact`;
      const res = await fetch(url);
      const data = await res.json();
      const raw = data['Time Series FX (1min)'] || {};
      return Object.entries(raw).slice(0, 10).reverse().map(([time, val]) => ({
        time,
        open: parseFloat(val['1. open']),
        close: parseFloat(val['4. close'])
      }));
    }

    async function askOpenAI(bars) {
      const res = await fetch('/api/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ candles: bars })
      });
      const json = await res.json();
      return json.signal || 'No signal';
    }

    async function updateBot() {
      const pair = pairSelect.value;
      const candles = await fetchCandles(pair);
      const times = candles.map(c => c.time.split(' ')[1]);
      const closes = candles.map(c => c.close);

      if (!chart) {
        chart = new Chart(chartCtx, {
          type: 'line',
          data: { labels: times, datasets: [{ label: pair, data: closes, borderColor: '#3b82f6' }] },
          options: { scales: { y: { beginAtZero: false } } }
        });
      } else {
        chart.data.labels = times;
        chart.data.datasets[0].data = closes;
        chart.update();
      }

      const signal = await askOpenAI(candles);
      const now = new Date().toLocaleTimeString();
      signalBox.innerText = `${signal} (${now})`;
      const li = document.createElement('li');
      li.innerText = `${now} | ${pair} â†’ ${signal}`;
      logBox.prepend(li);
      if (logBox.childNodes.length > 10) logBox.removeChild(logBox.lastChild);
    }

    updateBot();
    setInterval(updateBot, 60000);
  </script>
</body>
</html>
